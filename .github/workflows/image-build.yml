name: 🐳 Build and Push Docker Image

on:
  push:
    branches:
      - main
      - 'release/*'
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  changes:
    name: 🔎 Detect Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🚦 Calculate changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'src/**'
              - 'public/**'
              - '.github/workflows/image-build.yml'
              - 'Dockerfile'
              - 'nginx.conf'
              - 'index.html'
              - 'package.json'
              - 'package-lock.json'

  build-and-push:
    name: 🏗️ Build and Push Image
    needs: [changes]
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.get_tag.outputs.tag }}
    
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: ⚙️ Generate predictable image tag
        id: get_tag
        run: |
          TAG=""
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG=${{ github.ref_name }}
          else
            # Sanitize branch name for tag (e.g., 'release/1.0' -> 'release-1.0')
            TAG=$(echo ${{ github.ref_name }} | sed 's/\//-/g')
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${TAG}"

      - name: 🐳 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🔑 Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 🔨 Build and Push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.get_tag.outputs.tag }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ✅ Image Summary
        run: |
          echo "### 🖼️ Image Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** ${{ steps.build.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY

  update-manifest:
    name: 🔄 Update Kubernetes Manifest
    needs: [build-and-push]
    if: github.event_name != 'pull_request' && needs.build-and-push.outputs.image_tag != ''
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 📝 Update Image Tag in Manifest
        run: |
          IMAGE_TAG=${{ needs.build-and-push.outputs.image_tag }}
          MANIFEST_FILE=k8s/frontend-deployment.yaml
          echo "Updating image in $MANIFEST_FILE to ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG"
          sed -i "s|image: *|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG|" $MANIFEST_FILE

      - name: 🚀 Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ci: update k8s manifest with image ${{ needs.build-and-push.outputs.image_tag }} [skip ci]"
          branch: ${{ github.ref_name }}
          commit_options: '--no-verify'
          commit_user_name: 'yunjae-park1111'
          commit_user_email: 'yunjae.park@thakicloud.co.kr'
